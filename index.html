<!doctype html>
<html>
    <head>
        <title>Quick test console</title>
    </head>
    <body>
        <input type="text" name="username" placeholder="username" id="username">
        <input type="password" name="password" placeholder="password" id="password">
        <input type="submit" value="Submit" id="submit">
        <pre id="console"></pre>

        <script>
            const username = document.getElementById("username");
            const password = document.getElementById("password");
            let submit = document.getElementById("submit");
            const output = document.getElementById("console");

            let loggedin = null;
            let ws;
            submit.onclick = () => {
                fetch('/user/login', {
                    credentials: 'same-origin',
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username: username.value,
                        password: password.value
                    })

                })
                    .then(r => r.json())
                    .then(u => loggedin = u)
                    .then(() => {
                        password.parentNode.removeChild(password);
                        username.placeholder = "Message..."
                        const s = submit.cloneNode(true);
                        submit.parentNode.replaceChild(s, submit);
                        submit = s;
                    })
                    .then(() => {
                        ws = new WebSocket("ws://65.108.12.102:1422/chat/belst");

                        ws.onmessage = ({data: msg}) => {
                            output.append(msg);
                            output.append('\n');
                        };

                        submit.onclick = () => {
                            let msg = {};
                            msg.content = username.value;
                            ws.send(JSON.stringify(msg));
                        };
                    })
            };
        </script>
    </body>
</html>
